<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Unblock Me</title>
</head>
<body>
<div id="wrapper" style="display:block;margin:0 auto;text-align:center;cursor:default">
<canvas id="canvas">Your browser does not support canvas!</canvas>
<br />
<input type="button" value="Load game" onclick="lg(prompt('Enter new game string (leave blank for default)'))">
</div>
<script type="text/javascript">
var canvas = document.getElementById("canvas");
var cw = 300, ch = 300, gx, gy, ggoal, tw, th, gs, blks = [], gstd = false;
document.getElementById("wrapper").style.width = cw+4;
canvas.addEventListener("mousedown", tmd);
window.addEventListener("mouseup", tmu);
canvas.addEventListener("mousemove", tmm);
canvas.width = cw+9;
canvas.height = ch+9;
var ctx = canvas.getContext("2d");
var ab = [-1, '', [], [], [], [-1, -1, -1, -1]];
       //  0 = bid
       //      1 = v or h
       //         2 = [x, y]
       //                 4 = [w, h]

function dr(c1, c2, isgb)
{
    // DRAW ANIMAL
    ctx.fillStyle="#666";
    ctx.fillRect(c1[0] * tw + 3, c1[1] * th + 3, (c2[0] - c1[0]) * tw + 2, (c2[1] - c1[1]) * th + 2);
    ctx.fillStyle=(isgb ? "#e33" : "#ccc");
    ctx.fillRect(c1[0] * tw + 5, c1[1] * th + 5, (c2[0] - c1[0]) * tw - 2, (c2[1] - c1[1]) * th - 2);
}

function dg()
{
    ctx.clearRect(3, 3, canvas.width-7, canvas.height-7);
    for (var i in blks)
    {
        var b = blks[i];
        if (b[3] == ab[0]) dr(ab[2], [ab[2][0]+ab[4][0],ab[2][1]+ab[4][1]], b[2]);
        else dr(b[0], b[1], b[2]);
    }
}

function lg(gamestr)
{
    if (arguments.length == 0 || gamestr == null || gamestr.length == 0)
        gamestr = "6,6,5,2,0013,0531,1221g,1312,2012,2421,3031,3113,4213,5112,5312";
    var rb = gamestr.replace(/\s+/g, '').split(","), bid = 0;
    blks = [];
    // ANIMALS
    gx = +rb[0]; gy = +rb[1];
    tw = cw / gx, th = ch / gy;
    ggoal = [+rb[2], +rb[3]];
    gs = new Array(gx);
    for (var i = 0; i < gx; i++)
    {
        gs[i] = new Array(gy);
        for (var j = 0; j < gy; j++) gs[i][j] = -1;
    }
    for (var d=4; d<rb.length; d++)
    {
        var b = rb[d].split("");
        for (var i=0; i<4; i++) b[i]=+b[i];
        var corner1 = [b[0], b[1]];
        var corner2 = [b[0] + b[2], b[1] + b[3]];
        blks.push([corner1, corner2, b.length == 5, bid]);
        for (var i = corner1[0]; i < corner2[0]; i++)
            for (var j = corner1[1]; j < corner2[1]; j++)
                gs[i][j] = bid;
        bid++;
    }

    ctx.beginPath();
    ctx.rect(2, 2, cw+4, ch+4);
    ctx.strokeStyle = "#999";
    ctx.lineWidth = 3;
    ctx.stroke();
    ctx.beginPath();
    ctx.strokeStyle = "#fff";
    ctx.moveTo((ggoal[0]+1) * tw + 7, ggoal[1] * th + 3);
    ctx.lineTo((ggoal[0]+1) * tw + 7, (ggoal[1]+1) * th + 4);
    ctx.stroke();
    dg();
    gstd = true;
}

function gwin()
{
    alert("You win!");
    gstd = false;
}

function mxy(evt)
{
    var rt = canvas.getBoundingClientRect();
    return [(evt.clientX - rt.left)*(canvas.width/rt.width), (evt.clientY - rt.top)*(canvas.height/rt.height)];
}

function tmd(e)
{
    e.preventDefault();
    e.stopPropagation();
    if (!gstd) return false;
    var mpos = mxy(e);
    ab[0] = gs[Math.floor(mpos[0]/tw)][Math.floor(mpos[1]/th)];
    if (ab[0] == -1) return false;
    ab[4] = [blks[ab[0]][1][0] - blks[ab[0]][0][0], blks[ab[0]][1][1] - blks[ab[0]][0][1]];
    ab[1] = (ab[4][0] == 1) ? 'v' : 'h';
    ab[2] = [blks[ab[0]][0][0], blks[ab[0]][0][1]];
    ab[3] = [mpos[0] - ab[2][0]*tw, mpos[1] - ab[2][1]*th];
    for (var i = 0; i < ab[4][0]; i++)
        for (var j = 0; j < ab[4][1]; j++)
            gs[ab[2][0]+i][ab[2][1]+j] = -1;
    return false;
}

function tmu(e)
{
    e.preventDefault();
    e.stopPropagation();
    if (!gstd || ab[0] == -1) return false;
    ab[2] = [Math.round(ab[2][0]), Math.round(ab[2][1])];
    blks[ab[0]][0][0] = ab[2][0];
    blks[ab[0]][0][1] = ab[2][1];
    blks[ab[0]][1][0] = ab[2][0] + ab[4][0];
    blks[ab[0]][1][1] = ab[2][1] + ab[4][1];
    for (var i = 0; i < ab[4][0]; i++)
        for (var j = 0; j < ab[4][1]; j++)
            gs[ab[2][0]+i][ab[2][1]+j] = ab[0];
    if (blks[ab[0]][2] && blks[ab[0]][1][0] == ggoal[0]+1 && blks[ab[0]][1][1] == ggoal[1]+1)
        return gwin();
    ab = [-1, '', [], [], [], [-1, -1, -1, -1]];
    dg();
    return false;
}

function tmm(e)
{
    e.preventDefault();
    e.stopPropagation();
    if (!gstd || ab[0] == -1) return false;
    var mpos = mxy(e);
    var ab2 = [(ab[1]=='v') ? ab[2][0] : (mpos[0] - ab[3][0])/tw, (ab[1]=='h') ? ab[2][1] : (mpos[1] - ab[3][1])/th];
    var effc1 = [Math.floor(ab2[0]), Math.floor(ab2[1])];
    var effc2 = [effc1[0] + ab[4][0], effc1[1] + ab[4][1]];
    if (ab2[0] - ab[2][0] > 0 && (((effc2[0] < gx) ? gs[effc2[0]][effc1[1]] != -1 : true) || ab[5][0] != -1))
        ab2[0] = (ab[5][0] != -1) ? ab[5][0] : (ab[5][0]=effc1[0]);
    else if (ab2[0] - ab[2][0] < 0 && (((effc1[0] >= 0) ? gs[effc1[0]][effc1[1]] != -1 : true) || ab[5][1] != -1))
        ab2[0] = (ab[5][1] != -1) ? ab[5][1] : (ab[5][1]=effc1[0] + 1);
    else if (ab2[1] - ab[2][1] > 0 && (((effc2[1] < gy) ? gs[effc1[0]][effc2[1]] != -1 : true) || ab[5][2] != -1))
        ab2[1] = (ab[5][2] != -1) ? ab[5][2] : (ab[5][2]=effc1[1]);
    else if (ab2[1] - ab[2][1] < 0 && (((effc1[1] >= 0) ? gs[effc1[0]][effc1[1]] != -1 : true) || ab[5][3] != -1))
        ab2[1] = (ab[5][3] != -1) ? ab[5][3] : (ab[5][3]=effc1[1] + 1);
    else
        ab[5] = [-1, -1, -1, -1];
    ab[2] = [ab2[0], ab2[1]];
    dg();
    return false;
}

lg("");
</script>
</body>
</html>