<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>

        .tile {
            position: absolute;
            border: 0.5px solid black;
        }

        .board {
            width: 360px;
            height: 360px;
            position: absolute;
            top: 0px;
            left: 0px;
            background: #999966;
        }

        #levels {
            position: absolute;
            top: 360px;
            left: 0;
            width: 90%;
            text-align: center;
        }
    </style>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://rawgithub.com/briangonzalez/jquery.pep.js/master/src/jquery.pep.js"></script>

    <script src="../js/loadLevel.js"></script>
    <script type="text/javascript">

        /*
        Constants to store some board and tile variables
         */
        var BOARD_HEIGHT;
        var BOARD_WIDTH;
        var TILE_HEIGHT;
        var TILE_WIDTH;
        var FIRST_CELL = 0;
        var RIGHT_MOST_CELL;
        var BOTTOM_CELL;

        /*
        Function to check if a cell is empty. Coordinates given by x and y.
        x: X coordinate of cell to check.
        Y: Y coordinate of cell to check.
         */
        function isCellEmpty(x,y) {

            for (var i = 0; i < $.pep.peps.length; i++) {
                var block = $.pep.peps[i];

                if ( (getLeftCell(block) <= x) && (getRightCell(block) >= x) ) {

                    if ( (getTopCell(block) <= y) && (getBottomCell(block) >= y) ) {

                        //the cell is not empty;
                        return false;
                    }

                }
            }
            return true;
        }

        /*
        Function to get the cell to the left of the active block.
         thisBlock: The block/div to check.
         */
        function getLeftCell(thisBlock) {
            var i = getLeftPosition(thisBlock);
            if ( i > 0 ) {
                i = i / TILE_WIDTH;
            }
            return i;
        }

        /*
         Function to get the cell to the right of the active block.
         thisBlock: The active block.
         */
        function getRightCell(thisBlock) {
            var i = getLeftPosition(thisBlock) + getWidth(thisBlock);
            return (i / TILE_WIDTH) - 1;
        }

        /*
         Function to get the cell above the active block.
         thisBlock: The block/div to check.
         */
        function getTopCell(thisBlock) {
            var i = getTopPosition(thisBlock);
            if ( i > 0 ) {
                i = i / TILE_WIDTH;
            }
            return i;
        }

        /*
         Function to get the cell below the active block.
         thisBlock: The block/div to check.
         */
        function getBottomCell(thisBlock) {
            var i = getTopPosition(thisBlock) + getHeight(thisBlock);
            return (i / TILE_HEIGHT) - 1;
        }

        /*
        Function to get the left bound of the active block.
         thisBlock: The block/div to check.
         */
        function getLeftPosition(thisBlock) {
            return thisBlock.el.getBoundingClientRect().left;
        }

        /*
         Function to get the top bound of the active block.
         thisBlock: The block/div to check.
         */
        function getTopPosition(thisBlock) {
            return thisBlock.el.getBoundingClientRect().top;
        }

        /*
         Function to get the width of the active block.
         thisBlock: The block/div to check.
         */
        function getWidth(thisBlock) {
            return thisBlock.el.clientWidth;
        }

        /*
         Function to get the height of the active block.
         thisBlock: The block/div to check.
         */
        function getHeight(thisBlock) {
            return thisBlock.el.clientHeight;
        }

        /*
        Function to call the setConstrainsFor method on all blocks other than the active block.
        selectedBlock: The active block.
         */
        function setConstrains(selectedBlock) {

            //debugging:
            var p1 = $.pep.peps[0];
            var p2 = $.pep.peps[1];
            var p3 = $.pep.peps[2];
            var p4 = $.pep.peps[3];

            for (var i = 0; i < $.pep.peps.length; i++) {
                if ( $.pep.peps[i] == selectedBlock ) {
                    //we don't need to setConstrains for the selectedBlock...
                } else {
                    setConstrainsFor($.pep.peps[i]);
                };
            }
        }

        /*
        Function to set the constrains for the given block
        thisBlock: all blocks not active.
         */
        function setConstrainsFor(thisBlock) {

            var t = getTopCell(thisBlock);
            var r = 0;
            var b = 0;
            var l = getLeftCell(thisBlock);

            if (thisBlock.el.className.indexOf('dragX') > -1) { //horizontal

                while ( (l > FIRST_CELL) && isCellEmpty(l - 1, t) ) {
                    l-=1;
                }

                r = getRightCell(thisBlock);

                while ( (r < RIGHT_MOST_CELL) && isCellEmpty(r + 1, t) ) {
                    r+=1;
                }

            } else { //vertical

                while ( (t > FIRST_CELL) && isCellEmpty(l, t - 1) ) {
                    t-=1;
                }

                b = getBottomCell(thisBlock);

                while ( (b < BOTTOM_CELL) && isCellEmpty(l, b + 1) ) {
                    b+=1;
                }
            }

            t = t * TILE_HEIGHT;
            r = ((r + 1) * TILE_HEIGHT) - getWidth(thisBlock);
            l = l * TILE_WIDTH;
            b = ((b + 1) * TILE_WIDTH) - getHeight(thisBlock);

            thisBlock.options.constrainTo = [ t, r, b, l ];
        }

        // EDITED --------------------------------------
        // Dumped your loadPep code into a function
        /*
        Function to load all the pep data necessary for the board and tiles.
         */
        function loadPep() {
            BOARD_HEIGHT = parseInt($(".board").css('height'));
            BOARD_WIDTH = parseInt($(".board").css('width'));
            TILE_HEIGHT = BOARD_HEIGHT / 6;
            TILE_WIDTH = BOARD_WIDTH / 6;
            RIGHT_MOST_CELL = (BOARD_WIDTH / TILE_WIDTH) - 1;
            BOTTOM_CELL = (BOARD_HEIGHT / TILE_HEIGHT) - 1;

            $('.dragX').pep({
                axis: 'x',
                cssEaseDuration: 0,
                grid: [TILE_HEIGHT, TILE_WIDTH],
                shouldEase: false,
                stop: function(event, obj) {
                    setConstrains(obj);
                }
            });

            $('.dragY').pep({
                axis: 'y',
                cssEaseDuration: 0,
                grid: [TILE_HEIGHT, TILE_WIDTH],
                shouldEase: false,
                stop: function(event, obj) {
                    setConstrains(obj);
                }
            });

            setConstrains();
        }




        // ADDED ----------------------------------------------------------

        function lvl1() {
            var lvlString = '6,5,2,0021,5013,0113,3113,1221j,0412,4421,2531';
            loadLevel( lvlString, 'board', loadPep );
        }

        function lvl2() {
            var lvlString = '6,5,2,0013,0531,1221j,1312,2012,2421,3031,3113,4213,5112,5312';
            loadLevel( lvlString, 'board', loadPep );
        }

        // After board container loads, load the board pieces
        $( '#board' ).ready( function() {
            lvl1();
        } );

    </script>

</head>
<body>


<div id="board" class='board'></div>


<div id="levels">
    Level: <a href="#" onclick="lvl1()">1</a> | <a href="#" onclick="lvl2()">2</a>
</div>

</body>
</html>